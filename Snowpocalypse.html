<html>
<head>
<title>New Document - Created By AjaXplorer</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<link rel="stylesheet" type="text/css" href="snowpocalypse.css">
</head>
<body bgcolor="gray" text="#000000">
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript">
    var dataset, picdata, picdict = {}
    var imagedict = {}
    var margins = {top: 0, bottom: 30, left:100, right:0}
    var width = 1200 - margins.left - margins.right
    var height = 200 - margins.bottom - margins.top
    var svg
    var daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
    var dayFormat = d3.time.format("%Y-%m-%d %H:%M:%S")

    window.onload = function() {
      d3.tsv("allsnowdata.tsv", function(error, data) {
        if (error) {
          console.log(error);
        }
        else {
          drawPage();
          
          dataset = data.filter(function(element) 
            { 
              var dateFromString = dayFormat.parse(element.TweetTimeStamp); 
              var day = dateFromString.getDate()
              var hour = dateFromString.getHours()
              element.normDayHour = new Date(2014, 1, day, dateFromString.getHours(), 0, 0, 0)
              return ((day == 6) & (hour > 7)) || (day > 6); 
            });

          d3.tsv("snowpics.tsv", function(error, data) {
            if (error) {
              console.log(error)
            }
            else {
              for (i=0; i< data.length; i++) {
                picdict[data[i].TweetId] = data[i].TweetPicUrl
              }
            }
          })

          d3.tsv("fileNames.txt", function(error, data) {
            if (error) {
              console.log(error)
            }
            else {
              for(n=0; n<data.length;n++) {
                var imageAdd = new Image()
                imageAdd.src = "images/" + escape(data[n].fileName)
                imagedict[data[n].fileName] = imageAdd
              }
            }
          })


          console.log(imagedict);
          drawBars();
        }
      });
    };
    
    var drawPage = function() {
      d3.select("body")
        .append("p")
          .attr("class", "title")
          .text("#snowpocalypse")
          .attr("align", "center")

      d3.select("body")
        .append("div")
          .attr("class", "tweet")
        .append("p")

      /*d3.select("body")
        .append("img")
          .attr("class", "tweetpic")
          .attr("src", 'http://pbs.twimg.com/media/BgExeYvCQAABDBs.jpg')
          .attr("align", "middle")
          .attr("width", "300px")
          .attr("height", "200px")
      */
      var margin

      d3.select("body")
        .append("svg")
          .attr("class", "main")
          .attr("width", "300px")
          .attr("height", "200px")
        .append("image")
        .attr("class", "tweetpic")
          //.attr("xlink:href", 'http://pbs.twimg.com/media/BfzjXmGCUAAqOmp.jpg')
          .attr("width", "300px")
          .attr("height", "200px")
          //.attr("transform", "translate(" + margins.left + "," + margins.top + ")");

      svg = d3.select("body")
        .append("svg")
          .attr("width", width + margins.left + margins.right)
          .attr("height", height + margins.top + margins.bottom)
          .attr("class", "main")
        .append("g")
        .attr("transform", "translate(" + margins.left + "," + margins.top + ")");



      d3.select("body")
        .append("div")
          .attr("class", "spacer")

      d3.select("body")
        .append("div")
          .attr("class", "stats")
          .attr("align", "center")
          
          
    }
    
    var drawBars = function() { 
      

      var histogram = d3.layout.histogram()
                      .bins(82)
                      (dataset.map(function(element) { return element.normDayHour }))

      // draw axis

      var x = d3.scale.ordinal()
    .domain(histogram.map(function(d)
     { 
      //return d.x; 
      if (d.length > 0) {
        return daysOfWeek[d[0].getDay()]
      }
     }))
    .rangeBands([0, width], 0.2, 0.2)

 
    var y = d3.scale.linear()
    .domain([0, d3.max(histogram.map(function(d) { return d.y; }))])
    .range([height, 0]);

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(4)

      var xIndexes = d3.range(0, histogram.length)
      var xPos = d3.scale.linear()
        .domain([0,histogram.length])
        .range([0, width])

      var xBand = d3.scale.ordinal()
        .domain(xIndexes)
        .rangeBands([0, width], 0.2, 0.2)
      

      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("top")

              // draw bars
    
      var bars = svg.selectAll("rect")
        .data(histogram)

      bars 
         .enter()
         .append("rect")
          .attr("x", function(d,i) {
             return xPos(i)
           })
           .attr("y", height)
           .attr("fill", "white")      
          .attr("width", xBand.rangeBand())
           .attr("height", 0)
           .attr("cursor", "pointer")


      bars
        .transition()
        .delay(function(d,i) { return i*30})
        .duration(100)
        .ease("quad")
          .attr("height", function(d) { return height - y(d.y); })
          .attr("y", function(d) { return y(d.y); })
          
      bars.on("mouseover", function(d) {
        d3.select(this)
          .attr("fill", "red")
          .attr("opacity", 0.5)
        if (d.length > 0) {

          var tweets = dataset.filter(function(data) {
            var dateFromString = dayFormat.parse(data.TweetTimeStamp); 
            if((dateFromString.getDate() == d[0].getDate()) && (dateFromString.getHours() == d[0].getHours()))
              return data
            })
          if (tweets.length > 0) {

            var randomTweet = tweets[Math.floor(Math.random() * tweets.length)]
            d3.select(".tweet").text(randomTweet.TweetText)
            var matchIndex = /(http?:\/\/[\-\w@:%_\+.~#?,&\/\/=]+)/.exec(randomTweet.TweetText)

            // clear image
            d3.select(".tweetpic")
                    .attr("xlink:href", "")

            if (matchIndex != null) {
              if (matchIndex[0] != null) {
                if (picdict[randomTweet.TweetId] != null) {
                  var url = picdict[randomTweet.TweetId]
                  var imagePath = url.split('\/')
                  var imageName = imagePath[imagePath.length - 1]
                  d3.select(".tweetpic")
                    .attr("xlink:href", "images/" + imageName)
                }
              }
            }
          }
          
        }
      });

      bars.on("mouseout", function(d) {
        d3.select(this).attr("fill", "white")
        d3.select(".tweet").text("")
      })

      bars.on("click", function(d) {
        if (d.length > 0)
          d3.select(".stats").text( "Feb " + d[0].getDate() + " " + d[0].getHours() + ":00 total tweets: " + d.length)
        else
          d3.select(".stats").text("total tweets: 0")
      })

      


      svg.append("g")
        .call(yAxis)
        .attr("class", "y axis")

      svg.append("g")
        .call(xAxis)
        .attr("class", "axis")
        .attr("transform", "translate(0," + (height + margins.bottom) + ")")


    };
    </script>

</body>
</html>
