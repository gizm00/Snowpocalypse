<html>
<head>
<title>New Document - Created By AjaXplorer</title>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <style type="text/css">
    div.bar {
      display: inline-block;
      width: 20px;
      height: 75px;  
      background-color: gray;
      margin-right: 2px;
      margin-bottom: 50px;
    }

    .y.axis line {
      fill: none;
      stroke: none;
      shape-rendering: crispEdges;
    }

    .axis path {
      fill: none;
      stroke: none;
      shape-rendering: crispEdges;
    }

    .axis text {
      fill: white;
    }


    div.tweet {
      width: 300px;
      height: 100px;
      text-align: center;
      margin-right: auto;
      margin-left: auto;
      color: white;
    }

    div.spacer {
      height: 30px;
    }

    div.stats {
      color:white;
      margin-right: auto;
      margin-left: auto;
    }

    

    p.title {
      font-size: 40px;
    }

    p {
      color: white
    }

    svg.main {
          margin-left: auto;
          margin-right: auto;
          display: block;
    }

    svg.image.tweetpic {
          margin-left: auto;
          margin-right: auto;
          display: block;
    }


    </style>
</head>
<body bgcolor="gray" text="#000000">
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <script type="text/javascript">
    var dataset
    var margins = {top: 0, bottom: 30, left:100, right:0}
    var width = 900 - margins.left - margins.right
    var height = 200 - margins.bottom - margins.top
    var svg
    var daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]
    var dayFormat = d3.time.format("%Y-%m-%d %H:%M:%S")

    window.onload = function() {
      d3.csv("allsnowtweets.csv", function(error, data) {
        if (error) {
          console.log(error);
        }
        else {
          drawPage();
          
          dataset = data.filter(function(element) 
            { 
              var dateFromString = dayFormat.parse(element.TweetTimeStamp); 
              var day = dateFromString.getDate()
              element.normDayHour = new Date(2014, 1, day, dateFromString.getHours(), 0, 0, 0)
              return day > 5; 
            });

          console.log(dataset);
          drawBars();
        }
      });
    };
    
    var drawPage = function() {
      d3.select("body")
        .append("p")
          .attr("class", "title")
          .text("#snowpocalypse")
          .attr("align", "center")

      d3.select("body")
        .append("div")
          .attr("class", "tweet")
        .append("p")

      /*d3.select("body")
        .append("img")
          .attr("class", "tweetpic")
          .attr("src", 'http://pbs.twimg.com/media/BgExeYvCQAABDBs.jpg')
          .attr("align", "middle")
          .attr("width", "300px")
          .attr("height", "200px")
      */
      var margin

      d3.select("body")
        .append("svg")
          .attr("class", "main")
          .attr("width", "300px")
          .attr("height", "200px")
        .append("image")
        .attr("class", "tweetpic")
          .attr("xlink:href", 'http://photos-c.ak.instagram.com/hphotos-ak-xpa1/1922006_756312981046930_1867062335_n.jpg')
          .attr("width", "300px")
          .attr("height", "200px")
          //.attr("transform", "translate(" + margins.left + "," + margins.top + ")");

      svg = d3.select("body")
        .append("svg")
          .attr("width", width + margins.left + margins.right)
          .attr("height", height + margins.top + margins.bottom)
          .attr("class", "main")
        .append("g")
        .attr("transform", "translate(" + margins.left + "," + margins.top + ")");



      d3.select("body")
        .append("div")
          .attr("class", "spacer")

      d3.select("body")
        .append("div")
          .attr("class", "stats")
          .attr("align", "center")
          
          
    }
    
    var drawBars = function() { 
      

      var histogram = d3.layout.histogram()
                      .bins(90)
                      (dataset.map(function(element) { return element.normDayHour }))

      // draw axis

      var x = d3.scale.ordinal()
    .domain(histogram.map(function(d)
     { 
      //return d.x; 
      if (d.length > 0) {
        return daysOfWeek[d[0].getDay()]
      }
     }))
    .rangeBands([0, width], 0.2, 0.2)

 
    var y = d3.scale.linear()
    .domain([0, d3.max(histogram.map(function(d) { return d.y; }))])
    .range([height, 0]);

      var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(4)

      var xIndexes = d3.range(0, histogram.length)
      var xPos = d3.scale.linear()
        .domain([0,histogram.length])
        .range([0, width])

      var xBand = d3.scale.ordinal()
        .domain(xIndexes)
        .rangeBands([0, width], 0.2, 0.2)
      

      var xAxis = d3.svg.axis()
        .scale(x)
        .orient("top")

              // draw bars
    
      var bars = svg.selectAll("rect")
        .data(histogram)

      bars 
         .enter()
         .append("rect")
          .attr("x", function(d,i) {
             return xPos(i)
           })
           .attr("y", height)
           .attr("fill", "white")      
          .attr("width", xBand.rangeBand())
           .attr("height", 0)
           .attr("cursor", "pointer")


      bars
        .transition()
        .delay(function(d,i) { return i*30})
        .duration(100)
        .ease("quad")
          .attr("height", function(d) { return height - y(d.y); })
          .attr("y", function(d) { return y(d.y); });
          
      bars.on("mouseover", function(d) {
        if (d.length > 0) {

          var tweets = dataset.filter(function(data) {
            var dateFromString = dayFormat.parse(data.TweetTimeStamp); 
            if((dateFromString.getDate() == d[0].getDate()) && (dateFromString.getHours() == d[0].getHours()))
              return data
         })
          if (tweets.length > 0) {

            d3.select(".tweet").text(tweets[Math.floor(Math.random() * tweets.length)].TweetText)
            var matchIndex = /(http?:\/\/[\-\w@:%_\+.~#?,&\/\/=]+)/.exec(d.TweetText)

            if (matchIndex != null) {
              if (matchIndex[0] != null) {
                var imageUrl = matchIndex[0]
                //d3.select(".tweetpic")
                //  .attr("xlink:href", imageUrl)
                //  .attr("x", 400)
                //  .attr("y", 400)
                //  .attr("width", 300)
                //  .attr("height", 200)
              }
            }
         }
          
        }

        d3.select(this)
          .attr("fill", "red")
          .attr("opacity", 0.5)
      });

      bars.on("mouseout", function(d) {
        d3.select(this).attr("fill", "white")
        d3.select(".tweet").text("")
      })

      bars.on("click", function(d) {
        if (d.length > 0)
          d3.select(".stats").text( "Feb " + d[0].getDate() + " " + d[0].getHours() + ":00 total tweets: " + d.length)
        else
          d3.select(".stats").text("total tweets: 0")
      })

      


      svg.append("g")
        .call(yAxis)
        .attr("class", "y axis")

      svg.append("g")
        .call(xAxis)
        .attr("class", "axis")
        .attr("transform", "translate(0," + (height + margins.bottom) + ")")


    };
    </script>

</body>
</html>
